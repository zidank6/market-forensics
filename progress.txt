## Codebase Patterns
- Keep pipeline outputs deterministic under outputs/
- Config values must be in config/*.json (no hardcoded thresholds)
- Python packages live in src/market_forensics/ with submodules: data/, events/, windows/, metrics/, plots/
- Use python3 (not python) for commands on macOS
- Sample data goes in data/sample/
- Type hints must be Python 3.9 compatible: use `from __future__ import annotations` and `Union[A, B]`, `List[T]` instead of `A | B`, `list[T]`
- Data loaders validate required columns and fail loudly with DataLoadError
- Canonical data types: Trade, TopOfBook, Event (all frozen dataclasses)
- Tests live in tests/ and can run standalone: PYTHONPATH=src python3 -m tests.test_<module>
- Event detectors validate inputs and raise DetectorError for invalid parameters
- Window extractors validate inputs and raise WindowError for invalid parameters
- Overlap handling for events: "keep_first" strategy is deterministic and documented
- Metrics calculator uses MetricsError for computation failures
- WindowMetrics and EventMetrics are dataclasses with to_dict() for serialization

---

## [2026-02-02 13:35] - MF-001
- What was implemented:
  - Created project directory structure: src/market_forensics/, data/sample/, outputs/{windows,metrics,plots}/, config/
  - Added config/default.json with exchange, symbols, event detection thresholds, window sizes
  - Added config loader utility in src/market_forensics/config.py
  - Updated README.md with project overview, structure, and "How to run" section
- Files changed:
  - README.md (updated)
  - config/default.json (new)
  - src/market_forensics/__init__.py (new)
  - src/market_forensics/config.py (new)
  - src/market_forensics/{data,events,windows,metrics,plots}/__init__.py (new)
  - data/sample/.gitkeep, outputs/*/.gitkeep (new)
- **Learnings for future iterations:**
  - Use python3 instead of python on macOS
  - Keep __init__.py files minimal with just docstrings
  - Config loader uses Path for cross-platform compatibility
---

## [2026-02-02 14:00] - MF-002
- What was implemented:
  - Canonical data models in src/market_forensics/data/models.py: Trade, TopOfBook, Event
  - Data loaders in src/market_forensics/data/loaders.py: CSV/JSONL for trades and top-of-book
  - Sample dataset in data/sample/: trades.csv (25 trades) and tob.csv (25 snapshots)
  - Demo script scripts/load_sample_data.py to validate loading pipeline
- Files changed:
  - src/market_forensics/data/models.py (new)
  - src/market_forensics/data/loaders.py (new)
  - src/market_forensics/data/__init__.py (updated with exports)
  - src/market_forensics/config.py (fixed path calculation)
  - data/sample/trades.csv (new)
  - data/sample/tob.csv (new)
  - scripts/load_sample_data.py (new)
- **Learnings for future iterations:**
  - Python 3.9 requires `from __future__ import annotations` for modern type hint syntax
  - Frozen dataclasses with __post_init__ validation work well for immutable data records
  - TopOfBook has computed properties: mid_price, spread, spread_bps
  - Loaders auto-detect format from file extension (.csv, .jsonl)
  - Timestamps support ISO 8601 and Unix timestamp (seconds or milliseconds)
---

## [2026-02-02 14:30] - MF-003
- What was implemented:
  - Price-shock event detector in src/market_forensics/events/detector.py
  - Config-driven detection via detect_price_shocks_from_config()
  - Returns list of Event objects with timestamp, symbol, direction (up/down), magnitude
  - Rolling window approach: compares current price to reference price within window
  - Deduplication logic: keeps largest magnitude event within each window period
  - Test suite in tests/test_detector.py with 15 unit-like assertions
- Files changed:
  - src/market_forensics/events/detector.py (new)
  - src/market_forensics/events/__init__.py (updated with exports)
  - tests/__init__.py (new)
  - tests/test_detector.py (new)
  - prd.json (MF-003 passes: true)
- **Learnings for future iterations:**
  - Event detector uses DetectorError for validation failures (analogous to DataLoadError)
  - Tests can run standalone: PYTHONPATH=src python3 -m tests.test_detector
  - Edge cases covered: empty data, constant price, duplicated timestamps, unsorted timestamps
  - detect_price_shocks() accepts both List[Trade] and List[TopOfBook]
  - Event metadata includes reference_price, current_price, threshold_pct, window_seconds
---

## [2026-02-02 15:00] - MF-004
- What was implemented:
  - Window extractor in src/market_forensics/windows/extractor.py
  - EventWindow dataclass: container for pre/post trades and tob around an event
  - extract_window(): extracts single event window with configurable pre/post duration
  - extract_windows(): handles multiple events with overlap strategy ("keep_first")
  - extract_windows_from_config(): reads window durations from config file
  - save_window() / save_windows(): persist to outputs/windows/ as JSON (event) + CSV (data)
  - Test suite in tests/test_windows.py with 18 unit-like assertions
- Files changed:
  - src/market_forensics/windows/extractor.py (new)
  - src/market_forensics/windows/__init__.py (updated with exports)
  - tests/test_windows.py (new)
  - prd.json (MF-004 passes: true)
- **Learnings for future iterations:**
  - Window boundaries: pre-window is (event-pre_sec, event), post-window is [event, event+post_sec)
  - Overlap handling: "keep_first" strategy skips events whose timestamp falls within a prior event's post-window
  - WindowError is the exception class for window extraction failures
  - Window ID format: {symbol}_{YYYYMMDD_HHMMSS}_{event_type} for deterministic filenames
  - Output files per window: _event.json, _pre_trades.csv, _post_trades.csv, _pre_tob.csv, _post_tob.csv
---

## [2026-02-02 15:30] - MF-005
- What was implemented:
  - Metrics calculator in src/market_forensics/metrics/calculator.py
  - WindowMetrics dataclass: trade_count, trade_volume, avg_trade_size, vwap, spread metrics, realized_volatility
  - EventMetrics dataclass: combines pre and post window metrics with event metadata
  - compute_trade_metrics(): count, volume, avg size, VWAP, realized vol (std of log returns), min/max price
  - compute_tob_metrics(): avg spread, avg spread_bps, avg midprice
  - compute_window_metrics() / compute_event_metrics() / compute_all_metrics(): aggregation functions
  - save_metrics(): saves to JSON and CSV with flattened structure (pre_*, post_* prefixed columns)
  - Test suite in tests/test_metrics.py with 17 unit-like assertions
- Files changed:
  - src/market_forensics/metrics/calculator.py (new)
  - src/market_forensics/metrics/__init__.py (updated with exports)
  - tests/test_metrics.py (new)
  - prd.json (MF-005 passes: true)
- **Learnings for future iterations:**
  - MetricsError is the exception class for metrics computation failures (follows DataLoadError pattern)
  - Realized volatility uses std deviation of log returns (needs >= 2 data points)
  - VWAP = sum(price * size) / sum(size)
  - EventMetrics.to_dict() flattens pre/post metrics with prefixes for easy CSV export
  - Empty windows return zeros for counts, None for averages
---
