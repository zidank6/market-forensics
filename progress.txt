## Codebase Patterns
- Keep pipeline outputs deterministic under outputs/
- Config values must be in config/*.json (no hardcoded thresholds)
- Python packages live in src/market_forensics/ with submodules: data/, events/, windows/, metrics/, plots/
- Use python3 (not python) for commands on macOS
- Sample data goes in data/sample/
- Type hints must be Python 3.9 compatible: use `from __future__ import annotations` and `Union[A, B]`, `List[T]` instead of `A | B`, `list[T]`
- Data loaders validate required columns and fail loudly with DataLoadError
- Canonical data types: Trade, TopOfBook, Event (all frozen dataclasses)
- Tests live in tests/ and can run standalone: PYTHONPATH=src python3 -m tests.test_<module>
- Event detectors validate inputs and raise DetectorError for invalid parameters
- Window extractors validate inputs and raise WindowError for invalid parameters
- Overlap handling for events: "keep_first" strategy is deterministic and documented
- Metrics calculator uses MetricsError for computation failures
- WindowMetrics and EventMetrics are dataclasses with to_dict() for serialization
- Ordering detector uses OrderingError and OnsetType enum (LIQUIDITY, VOLUME, PRICE)
- Classification outputs: liquidity-first, volume-first, price-first, undetermined
- Plots use matplotlib (optional); summary tables (CSV) work without it
- Plot filenames are deterministic: {window_id}_{type}.png
- Pipeline runner: PYTHONPATH=src python3 -m market_forensics.run

---

## [2026-02-02 13:35] - MF-001
- What was implemented:
  - Created project directory structure: src/market_forensics/, data/sample/, outputs/{windows,metrics,plots}/, config/
  - Added config/default.json with exchange, symbols, event detection thresholds, window sizes
  - Added config loader utility in src/market_forensics/config.py
  - Updated README.md with project overview, structure, and "How to run" section
- Files changed:
  - README.md (updated)
  - config/default.json (new)
  - src/market_forensics/__init__.py (new)
  - src/market_forensics/config.py (new)
  - src/market_forensics/{data,events,windows,metrics,plots}/__init__.py (new)
  - data/sample/.gitkeep, outputs/*/.gitkeep (new)
- **Learnings for future iterations:**
  - Use python3 instead of python on macOS
  - Keep __init__.py files minimal with just docstrings
  - Config loader uses Path for cross-platform compatibility
---

## [2026-02-02 14:00] - MF-002
- What was implemented:
  - Canonical data models in src/market_forensics/data/models.py: Trade, TopOfBook, Event
  - Data loaders in src/market_forensics/data/loaders.py: CSV/JSONL for trades and top-of-book
  - Sample dataset in data/sample/: trades.csv (25 trades) and tob.csv (25 snapshots)
  - Demo script scripts/load_sample_data.py to validate loading pipeline
- Files changed:
  - src/market_forensics/data/models.py (new)
  - src/market_forensics/data/loaders.py (new)
  - src/market_forensics/data/__init__.py (updated with exports)
  - src/market_forensics/config.py (fixed path calculation)
  - data/sample/trades.csv (new)
  - data/sample/tob.csv (new)
  - scripts/load_sample_data.py (new)
- **Learnings for future iterations:**
  - Python 3.9 requires `from __future__ import annotations` for modern type hint syntax
  - Frozen dataclasses with __post_init__ validation work well for immutable data records
  - TopOfBook has computed properties: mid_price, spread, spread_bps
  - Loaders auto-detect format from file extension (.csv, .jsonl)
  - Timestamps support ISO 8601 and Unix timestamp (seconds or milliseconds)
---

## [2026-02-02 14:30] - MF-003
- What was implemented:
  - Price-shock event detector in src/market_forensics/events/detector.py
  - Config-driven detection via detect_price_shocks_from_config()
  - Returns list of Event objects with timestamp, symbol, direction (up/down), magnitude
  - Rolling window approach: compares current price to reference price within window
  - Deduplication logic: keeps largest magnitude event within each window period
  - Test suite in tests/test_detector.py with 15 unit-like assertions
- Files changed:
  - src/market_forensics/events/detector.py (new)
  - src/market_forensics/events/__init__.py (updated with exports)
  - tests/__init__.py (new)
  - tests/test_detector.py (new)
  - prd.json (MF-003 passes: true)
- **Learnings for future iterations:**
  - Event detector uses DetectorError for validation failures (analogous to DataLoadError)
  - Tests can run standalone: PYTHONPATH=src python3 -m tests.test_detector
  - Edge cases covered: empty data, constant price, duplicated timestamps, unsorted timestamps
  - detect_price_shocks() accepts both List[Trade] and List[TopOfBook]
  - Event metadata includes reference_price, current_price, threshold_pct, window_seconds
---

## [2026-02-02 15:00] - MF-004
- What was implemented:
  - Window extractor in src/market_forensics/windows/extractor.py
  - EventWindow dataclass: container for pre/post trades and tob around an event
  - extract_window(): extracts single event window with configurable pre/post duration
  - extract_windows(): handles multiple events with overlap strategy ("keep_first")
  - extract_windows_from_config(): reads window durations from config file
  - save_window() / save_windows(): persist to outputs/windows/ as JSON (event) + CSV (data)
  - Test suite in tests/test_windows.py with 18 unit-like assertions
- Files changed:
  - src/market_forensics/windows/extractor.py (new)
  - src/market_forensics/windows/__init__.py (updated with exports)
  - tests/test_windows.py (new)
  - prd.json (MF-004 passes: true)
- **Learnings for future iterations:**
  - Window boundaries: pre-window is (event-pre_sec, event), post-window is [event, event+post_sec)
  - Overlap handling: "keep_first" strategy skips events whose timestamp falls within a prior event's post-window
  - WindowError is the exception class for window extraction failures
  - Window ID format: {symbol}_{YYYYMMDD_HHMMSS}_{event_type} for deterministic filenames
  - Output files per window: _event.json, _pre_trades.csv, _post_trades.csv, _pre_tob.csv, _post_tob.csv
---

## [2026-02-02 15:30] - MF-005
- What was implemented:
  - Metrics calculator in src/market_forensics/metrics/calculator.py
  - WindowMetrics dataclass: trade_count, trade_volume, avg_trade_size, vwap, spread metrics, realized_volatility
  - EventMetrics dataclass: combines pre and post window metrics with event metadata
  - compute_trade_metrics(): count, volume, avg size, VWAP, realized vol (std of log returns), min/max price
  - compute_tob_metrics(): avg spread, avg spread_bps, avg midprice
  - compute_window_metrics() / compute_event_metrics() / compute_all_metrics(): aggregation functions
  - save_metrics(): saves to JSON and CSV with flattened structure (pre_*, post_* prefixed columns)
  - Test suite in tests/test_metrics.py with 17 unit-like assertions
- Files changed:
  - src/market_forensics/metrics/calculator.py (new)
  - src/market_forensics/metrics/__init__.py (updated with exports)
  - tests/test_metrics.py (new)
  - prd.json (MF-005 passes: true)
- **Learnings for future iterations:**
  - MetricsError is the exception class for metrics computation failures (follows DataLoadError pattern)
  - Realized volatility uses std deviation of log returns (needs >= 2 data points)
  - VWAP = sum(price * size) / sum(size)
  - EventMetrics.to_dict() flattens pre/post metrics with prefixes for easy CSV export
  - Empty windows return zeros for counts, None for averages
---

## [2026-02-02 16:00] - MF-006
- What was implemented:
  - Change ordering detector in src/market_forensics/events/ordering.py
  - OnsetDetection dataclass: stores onset time, baseline, threshold, and value for each signal
  - EventOrdering dataclass: combines all three signal onsets with classification
  - detect_spread_onset(): detects liquidity withdrawal (spread widening)
  - detect_volume_onset(): detects volume spikes (bucketed by time)
  - detect_price_onset(): detects price movement (direction-aware)
  - determine_ordering(): sorts onsets by time and classifies as liquidity/volume/price-first
  - analyze_event_ordering() / analyze_all_orderings(): full analysis pipeline
  - save_orderings(): saves to JSON and CSV
  - README updated with detailed assumptions & limitations section
  - Test suite in tests/test_ordering.py with 19 unit-like assertions
- Files changed:
  - src/market_forensics/events/ordering.py (new)
  - src/market_forensics/events/__init__.py (updated with exports)
  - tests/test_ordering.py (new)
  - README.md (updated with ordering assumptions/limitations)
  - prd.json (MF-006 passes: true)
- **Learnings for future iterations:**
  - OrderingError is the exception class for ordering detection failures
  - Onset threshold = baseline + k*std (from pre-window), configurable via ordering_detection.threshold_std_multiplier
  - Volume is bucketed into configurable time intervals (default 5s) before computing baseline
  - Classification: liquidity-first, volume-first, price-first, or undetermined
  - Price onset is direction-aware: looks for price below threshold for down events, above for up events
---

## [2026-02-02 16:30] - MF-007
- What was implemented:
  - Plot generator in src/market_forensics/plots/generator.py
  - Per-event plots: plot_event_price(), plot_event_spread(), plot_event_volume()
  - Aggregate plots: plot_ordering_distribution(), plot_ordering_by_symbol()
  - Summary table: generate_summary_table() for ordering counts by symbol (CSV, no matplotlib required)
  - generate_all_plots(): orchestrates all plot generation
  - Graceful handling when matplotlib not installed (MATPLOTLIB_AVAILABLE flag)
  - PlotPaths dataclass for structured return of per-event plot paths
  - Filenames are deterministic: {window_id}_{type}.png, ordering_distribution.png, ordering_by_symbol.png
  - Test suite in tests/test_plots.py with 8 unit-like assertions
- Files changed:
  - src/market_forensics/plots/generator.py (new)
  - src/market_forensics/plots/__init__.py (updated with exports)
  - tests/test_plots.py (new)
  - prd.json (MF-007 passes: true)
- **Learnings for future iterations:**
  - PlotError is the exception class for plotting failures (e.g., missing matplotlib)
  - Use matplotlib.use('Agg') for non-interactive file-saving backend
  - Summary table (CSV) works without matplotlib, plots require it
  - Plot filenames: {window_id}_price.png, {window_id}_spread.png, {window_id}_volume.png
  - Volume plots bucket trades by time (default 5s) for cleaner visualization
---

## [2026-02-02 17:00] - MF-008
- What was implemented:
  - Pipeline runner in src/market_forensics/run.py
  - run_pipeline(): orchestrates full pipeline (events -> windows -> metrics -> ordering -> plots)
  - CLI with argparse: supports --config, --trades, --tob, --output, --quiet flags
  - Default paths point to sample data for easy testing
  - Generates run_summary.json with all output paths
  - Progress logging with verbose/quiet mode
  - Prints ordering classification summary at end
  - README updated with exact command and expected outputs structure
  - Lowered default threshold to 0.5% to detect events in sample data
- Files changed:
  - src/market_forensics/run.py (new)
  - README.md (updated with command docs and output structure)
  - config/default.json (updated threshold to 0.5%)
  - prd.json (MF-008 passes: true)
- **Learnings for future iterations:**
  - Use PYTHONPATH=src python3 -m market_forensics.run to run pipeline
  - Default config at config/default.json, sample data at data/sample/
  - Pipeline outputs to outputs/ with subdirs: windows/, metrics/, plots/
  - run_summary.json contains full manifest of generated files
  - Sample data has ~0.7% price shock, so 0.5% threshold detects it
---
